name: Build and Deploy to DigitalOcean

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Enable manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      HOST: "yourplace.network"

    steps:
    - uses: actions/checkout@v3

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get upgrade -y
        sudo apt-get install -y build-essential make npm

    - name: Install dependencies
      run: make clean install

    - name: Build
      run: make build

    - name: Create keys and certificates
      run : |
        mkdir -p ~/.ssh
        echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ vars.DO_SSH_HOST }} >> ~/.ssh/known_hosts
        echo "${{ secrets.CF_ORIGIN_KEY }}" > ~/cert.key
        chmod 600 ~/cert.key
        echo "${{ secrets.CF_ORIGIN_PEM }}" > ~/cert.pem
        chmod 600 ~/cert.pem

    - name: Copy files to droplet
      run: |
        scp -i ~/.ssh/id_rsa ./target/YourPlaceLanding ${{ vars.DO_SSH_USER }}@${{ vars.DO_SSH_HOST }}:/opt/YourPlace/YourPlaceLanding.new
        scp -i ~/.ssh/id_rsa ~/cert.pem ${{ vars.DO_SSH_USER }}@${{ vars.DO_SSH_HOST }}:/opt/YourPlace/cert.pem
        scp -i ~/.ssh/id_rsa ~/cert.key ${{ vars.DO_SSH_USER }}@${{ vars.DO_SSH_HOST }}:/opt/YourPlace/cert.key
        scp -i ~/.ssh/id_rsa ./resources/yourplace.service ${{ vars.DO_SSH_USER }}@${{ vars.DO_SSH_HOST }}:/tmp/yourplace.service
        
    - name: Deploy and restart service
      run: |
        ssh -i ~/.ssh/id_rsa ${{ vars.DO_SSH_USER }}@${{ vars.DO_SSH_HOST }} << 'EOF'
          mkdir -p /opt/YourPlace
          systemctl stop yourplace
          mv /opt/YourPlace/YourPlaceLanding.new /opt/YourPlace/YourPlaceLanding
          chmod +x /opt/YourPlace/YourPlaceLanding
          mv /tmp/yourplace.service /etc/systemd/system/yourplace.service
          systemctl daemon-reload
          systemctl start yourplace
          sleep 5
          systemctl enable yourplace
          systemctl status yourplace
        EOF

    - name: Fetch logs
      run: |
        mkdir -p logs
        scp -i ~/.ssh/id_rsa ${{ vars.DO_SSH_USER }}@${{ vars.DO_SSH_HOST }}:/var/log/yourplace.log ./logs/
        scp -i ~/.ssh/id_rsa ${{ vars.DO_SSH_USER }}@${{ vars.DO_SSH_HOST }}:/var/log/yourplace.error.log ./logs/

    - name: Upload logs as artifacts
      uses: actions/upload-artifact@v2
      with:
        name: yourplace-logs
        path: logs/

    - name: Purge Cloudflare Cache
      run: |
        curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
        -H "Content-Type: application/json" \
        -H "X-Auth-Email: ${{ secrets.CF_EMAIL }}" \
        -H "X-Auth-Key: ${{ secrets.CF_TOKEN }}" \
        -d "{\"purge_everything\":true}"

    - name: Clean up
      run: |
        rm -rf ~/.ssh
        rm -rf ~/cert.pem
        rm -rf ~/cert.key
