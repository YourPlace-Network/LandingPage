name: Build and Deploy to DigitalOcean

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Enable manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get upgrade -y
        sudo apt-get install -y build-essential make npm

    - name: Install dependencies
      run: make clean install

    - name: Build
      run: make build

    - name: Create SSH key from secret
      run : |
        mkdir -p ~/.ssh
        echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ vars.DO_SSH_HOST }} >> ~/.ssh/known_hosts

    - name: Execute remote commands 1
      run: |
        ssh -i ~/.ssh/id_rsa ${{ vars.DO_SSH_USER }}@${{ vars.DO_SSH_HOST }} '
          mkdir -p /opt/YourPlace

    - name: Copy binary to droplet
      run: |
        scp -i ~/.ssh/id_rsa ./target/YourPlaceLanding ${{ vars.DO_SSH_USER }}@${{ vars.DO_SSH_HOST }}:/opt/YourPlace/YourPlaceLanding

    - name: Execute remote commands 2
      run: |
        ssh -i ~/.ssh/id_rsa ${{ vars.DO_SSH_USER }}@${{ vars.DO_SSH_HOST }} '
          screen -X -S YourPlaceLanding quit || true
          screen -dmS /opt/YourPlace/YourPlaceLanding bash -c "YourPlaceLanding"

    - name: Clean up
      run: rm -rf ~/.ssh
